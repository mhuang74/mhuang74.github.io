---
export interface Props {
  id: string;
  dataUrl: string;
  pageLength?: number;
}

const { id, dataUrl, pageLength = 10 } = Astro.props;
---

<div id={id} class="datatable-container my-8"></div>

<script is:inline define:vars={{ id, dataUrl, pageLength }}>
  // Proper CSV parser that handles quoted fields with commas
  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const nextChar = line[i + 1];

      if (char === '"') {
        if (inQuotes && nextChar === '"') {
          // Escaped quote
          current += '"';
          i++;
        } else {
          // Toggle quote state
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        // End of field
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }

    // Add last field
    result.push(current);

    return result;
  }

  // Wait for jQuery and DataTables to load
  function initDataTable() {
    if (typeof jQuery !== 'undefined' && jQuery.fn.DataTable) {
      jQuery.ajax({
        url: dataUrl,
        dataType: 'text',
        success: function(data) {
          // Parse CSV data
          const lines = data.split('\n').filter(function(line) { return line.trim(); });
          const headers = parseCSVLine(lines[0]);

          // Create table HTML
          let tableHtml = '<table id="' + id + '-table" class="display" style="width:100%"><thead><tr>';
          headers.forEach(function(header) {
            tableHtml += '<th>' + header.trim() + '</th>';
          });
          tableHtml += '</tr></thead><tbody>';

          // Add data rows
          for (let i = 1; i < lines.length; i++) {
            const cells = parseCSVLine(lines[i]);
            if (cells.length === headers.length) {
              tableHtml += '<tr>';
              cells.forEach(function(cell) {
                // Escape HTML to prevent XSS
                const escaped = cell.replace(/&/g, '&amp;')
                                   .replace(/</g, '&lt;')
                                   .replace(/>/g, '&gt;')
                                   .replace(/"/g, '&quot;');
                tableHtml += '<td>' + escaped + '</td>';
              });
              tableHtml += '</tr>';
            }
          }
          tableHtml += '</tbody></table>';

          // Insert table into container
          jQuery('#' + id).html(tableHtml);

          // Initialize DataTable
          jQuery('#' + id + '-table').DataTable({
            pageLength: pageLength,
            order: [[0, 'desc']],
            responsive: true,
            scrollX: true
          });
        },
        error: function(_xhr, _status, error) {
          console.error('Error loading data:', error);
          jQuery('#' + id).html('<p style="color: red;">Error loading table data. Please check the data URL.</p>');
        }
      });
    } else {
      setTimeout(initDataTable, 100);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDataTable);
  } else {
    initDataTable();
  }
</script>

<style>
  .datatable-container {
    width: 100%;
    max-width: 100%;
    overflow-x: auto;
  }

  .datatable-container :global(table) {
    margin: 0 !important;
  }
</style>
